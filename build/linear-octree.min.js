/**
 * linear-octree v0.0.0 build Fri Nov 15 2019
 * https://github.com/vanruesc/linear-octree
 * Copyright 2019 Raoul van RÃ¼schen, Zlib
 */
"use strict";function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}(function(a,b){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?b(exports,require("math-ds"),require("iterator-result")):"function"==typeof define&&define.amd?define(["exports","math-ds","iterator-result"],b):(a=a||self,b(a.LINEAROCTREE={},a.MATHDS,a.ITERATORRESULT))})(void 0,function(a,e,f){'use strict';var C=Math.trunc,D=Math.pow,E=Math.abs,F=Math.min,G=Math.max;function g(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function h(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function i(a,b,c){return b&&h(a.prototype,b),c&&h(a,c),a}function j(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&m(a,b)}function k(a){return k=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)},k(a)}function m(a,b){return m=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a},m(a,b)}function n(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function o(a,b){return b&&("object"===_typeof(b)||"function"==typeof b)?b:n(a)}function q(a){return s(a)||t(a)||u()}function s(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function t(a){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a))return Array.from(a)}function u(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function w(a,b,c,d,e,f){var g=0;return a>b&&a>c?(e<a&&(g|=2),f<a&&(g|=1)):b>c?(d<b&&(g|=4),f<b&&(g|=1)):(d<c&&(g|=4),e<c&&(g|=2)),g}function x(a,b,c,d){var e,f=0;return b<c?(e=b,f=0):(e=c,f=1),d<e&&(f=2),U[a][f]}function y(a,c,e){var f,g,h,i,j,k,l,m,n,o=v.min.set(0,0,0),p=v.max.subVectors(a.max,a.min),q=a.getDimensions(b.min),r=b.max.copy(q).multiplyScalar(.5),s=d.origin.copy(c.origin),t=d.direction.copy(c.direction);return s.sub(a.getCenter(V)).add(r),e.value=0,0>t.x&&(s.x=q.x-s.x,t.x=-t.x,e.value|=4),0>t.y&&(s.y=q.y-s.y,t.y=-t.y,e.value|=2),0>t.z&&(s.z=q.z-s.z,t.z=-t.z,e.value|=1),f=1/t.x,g=1/t.y,h=1/t.z,i=(o.x-s.x)*f,j=(p.x-s.x)*f,k=(o.y-s.y)*g,l=(p.y-s.y)*g,m=(o.z-s.z)*h,n=(p.z-s.z)*h,G(G(i,k),m)<F(F(j,l),n)?[i,k,m,j,l,n]:null}function z(a,b,c,d,e,f,g,h,j,k,l,m,n){if(0<=k&&0<=l&&0<=m){var o=a.getKeyDesign();if(0===f||null!==b.data){var p=a.getCellSize(f),q=new R(b);q.id.set(f,o.packKey(Z.set(c,d,e))),q.min.copy(Z).multiplyScalar(p).add(a.min),q.max.copy(q.min).addScalar(p),n.push(q)}else if(0<b.children){var r,s,t,u=a.getGrid(--f),v=b.children,y=.5*(g+k),A=.5*(h+l),B=.5*(j+m),C=w(g,h,j,y,A,B);c<<=1,d<<=1,e<<=1;do switch(t=Y.value^C,s=0!=(v&1<<t),r=S[t],C){case 0:{s&&(Z.set(c+r[0],d+r[1],e+r[2]),z(a,u.get(o.packKey(Z)),Z.x,Z.y,Z.z,f,g,h,j,y,A,B,n)),C=x(C,y,A,B);break}case 1:{s&&(Z.set(c+r[0],d+r[1],e+r[2]),z(a,u.get(o.packKey(Z)),Z.x,Z.y,Z.z,f,g,h,B,y,A,m,n)),C=x(C,y,A,m);break}case 2:{s&&(Z.set(c+r[0],d+r[1],e+r[2]),z(a,u.get(o.packKey(Z)),Z.x,Z.y,Z.z,f,g,A,j,y,l,B,n)),C=x(C,y,l,B);break}case 3:{s&&(Z.set(c+r[0],d+r[1],e+r[2]),z(a,u.get(o.packKey(Z)),Z.x,Z.y,Z.z,f,g,A,B,y,l,m,n)),C=x(C,y,l,m);break}case 4:{s&&(Z.set(c+r[0],d+r[1],e+r[2]),z(a,u.get(o.packKey(Z)),Z.x,Z.y,Z.z,f,y,h,j,k,A,B,n)),C=x(C,k,A,B);break}case 5:{s&&(Z.set(c+r[0],d+r[1],e+r[2]),z(a,u.get(o.packKey(Z)),Z.x,Z.y,Z.z,f,y,h,B,k,A,m,n)),C=x(C,k,A,m);break}case 6:{s&&(Z.set(c+r[0],d+r[1],e+r[2]),z(a,u.get(o.packKey(Z)),Z.x,Z.y,Z.z,f,y,A,j,k,l,B,n)),C=x(C,k,l,B);break}case 7:{s&&(Z.set(c+r[0],d+r[1],e+r[2]),z(a,u.get(o.packKey(Z)),Z.x,Z.y,Z.z,f,y,A,B,k,l,m,n)),C=8;break}}while(8>C)}}}function A(a,b,c,d,e,f){var g,h,j,k,l,m,n;if(0<f){for(--f,g=a.getGrid(f),h=a.getKeyDesign(),j=b.children,c<<=1,d<<=1,e<<=1,n=0;8>n;++n)0!=(j&1<<n)&&(l=S[n],aa.set(c+l[0],d+l[1],e+l[2]),m=h.packKey(aa),k=g.get(m),g["delete"](m),A(a,k,aa.x,aa.y,aa.z,f));b.children=0}}function B(a,b,c,d,e){var f,g,h,j;++e<a.levels&&(f=a.getGrid(e),g=ba.calculateOffsetIndex(b,c,d),aa.set(b>>>1,c>>>1,d>>>1),h=a.getKeyDesign().packKey(aa),j=f.get(h),j.children&=~(1<<g),0===j.children&&(f["delete"](h),B(a,aa.x,aa.y,aa.z,e)))}f=f&&f.hasOwnProperty("default")?f["default"]:f;var H=function a(){g(this,a),this.data=null},I=function(a){function b(){var a;return g(this,b),a=o(this,k(b).call(this)),a.children=0,a}return j(b,a),b}(H),J=function(){function a(){g(this,a)}return i(a,null,[{key:"parseBin",value:function(a){return parseInt(a,2)}},{key:"createBinaryString",value:function(a){for(var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:64,c=0>a?"-":"",d=E(a).toString(2);d.length<b;)d="0"+d;return c+d}}]),a}(),K=function(){function a(b,c,d){g(this,a),this.keyDesign=b,this.min=c,this.max=d,this.keyBase=new e.Vector3,this.key=new e.Vector3,this.limit=new e.Vector3,this.result=new f,this.reset()}return i(a,[{key:"reset",value:function(){var a=this.keyDesign,b=this.min,c=this.max;return b.x<=c.x&&b.y<=c.y&&b.z<=c.z?(this.keyBase.set(b.x,b.y*a.rangeX,b.z*a.rangeXY),this.limit.set(c.x,c.y*a.rangeX,c.z*a.rangeXY),this.key.copy(this.keyBase)):(this.keyBase.set(1,1,1),this.limit.set(0,0,0),this.key.copy(this.keyBase),console.error("Invalid key range",b,c)),this.result.reset(),this}},{key:"next",value:function(){var a=this.result,b=this.keyDesign,c=this.keyBase,d=this.limit,e=this.key;return e.z<=d.z?(a.value=e.z+e.y+e.x,++e.x,e.x>d.x&&(e.x=c.x,e.y+=b.rangeX,e.y>d.y&&(e.y=c.y,e.z+=b.rangeXY))):(a.value=null,a.done=!0),a}},{key:"return",value:function(a){return this.result.value=a,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),a}(),L=32,M=D(2,L),N=53,O=32,P=function(){var b=Math.round;function a(){var c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:b(.4*N),d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:b(.2*N),e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:c;g(this,a),this.x=0,this.y=0,this.z=0,this.rangeX=0,this.rangeY=0,this.rangeZ=0,this.rangeXY=0,this.halfRange=null,this.maskX=[0,0],this.maskY=[0,0],this.maskZ=[0,0],this.set(c,d,e)}return i(a,[{key:"set",value:function(a,c,d){(a+c+d>N||a>L||c>L||d>L)&&(console.warn("Invalid bit allotment"),a=b(.4*N),c=b(.2*N),d=a),this.x=a,this.y=c,this.z=d,this.rangeX=D(2,a),this.rangeY=D(2,c),this.rangeZ=D(2,d),this.rangeXY=D(2,a+c),this.halfRange=new e.Vector3(this.rangeX/2,this.rangeY/2,this.rangeZ/2),this.updateBitMasks()}},{key:"updateBitMasks",value:function(){var a=this.x,b=this.y,c=this.z,d=this.maskX,e=this.maskY,f=this.maskZ,g=L-G(0,a-O),h=L-G(0,b+a-O),i=L-G(0,c+b+a-O);d[1]=g<L?-1>>>g:0,d[0]=-1>>>G(0,O-a),e[1]=((h<L?-1>>>h:0)&~d[1])>>>0,e[0]=(-1>>>G(0,O-(a+b))&~d[0])>>>0,f[1]=((i<L?-1>>>i:0)&~e[1]&~d[1])>>>0,f[0]=(-1>>>G(0,O-(a+b+c))&~e[0]&~d[0])>>>0}},{key:"unpackKey",value:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new e.Vector3,c=this.maskX,d=this.maskY,f=this.maskZ,g=C(a/M),h=a%M;return b.set((g&c[1])*M+((h&c[0])>>>0),((g&d[1])*M+((h&d[0])>>>0))/this.rangeX,((g&f[1])*M+((h&f[0])>>>0))/this.rangeXY)}},{key:"packKey",value:function(a){return a.z*this.rangeXY+a.y*this.rangeX+a.x}},{key:"keyRange",value:function(a,b){return new K(this,a,b)}},{key:"toString",value:function(){var a=this.maskX,b=this.maskY,c=this.maskZ;return"Key Design\n\nX-Bits: "+this.x+"\nY-Bits: "+this.y+"\nZ-Bits: "+this.z+"\n\n"+J.createBinaryString(a[1],L)+" "+a[1]+" (HI-Mask X)\n"+J.createBinaryString(a[0],L)+" "+a[0]+" (LO-Mask X)\n\n"+J.createBinaryString(b[1],L)+" "+b[1]+" (HI-Mask Y)\n"+J.createBinaryString(b[0],L)+" "+b[0]+" (LO-Mask Y)\n\n"+J.createBinaryString(c[1],L)+" "+c[1]+" (HI-Mask Z)\n"+J.createBinaryString(c[0],L)+" "+c[0]+" (LO-Mask Z)\n"}}],[{key:"BITS",get:function(){return N}},{key:"HI_BITS",get:function(){return 21}},{key:"LO_BITS",get:function(){return O}}]),a}(),Q=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;g(this,a),this.level=b,this.key=c}return i(a,[{key:"set",value:function(a,b){this.level=a,this.key=b}},{key:"copy",value:function(a){return this.level=a.level,this.key=a.key,this}},{key:"clone",value:function(){return new this.constructor().copy(this)}}]),a}(),R=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new Q;g(this,a),this.octant=b,this.id=c,this.min=new e.Vector3,this.max=new e.Vector3}return i(a,[{key:"copy",value:function(a){return this.octant=a.octant,this.id.copy(a.id),this.min.copy(a.min),this.max.copy(a.max),this}},{key:"clone",value:function(){return new this.constructor().copy(this)}},{key:"getCenter",value:function(a){return a.addVectors(this.min,this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(a){return a.subVectors(this.max,this.min)}},{key:"containsPoint",value:function(a){var b=this.min,c=this.max;return a.x>=b.x&&a.y>=b.y&&a.z>=b.z&&a.x<=c.x&&a.y<=c.y&&a.z<=c.z}}]),a}(),S=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],T=new e.Vector3,c=new e.Vector3,U=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],V=new e.Vector3,v=new e.Box3,b=new e.Box3,d=new e.Ray,r=new e.Box3,W=new e.Box3,X=new e.Vector3,p=function(){function a(b){var c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;g(this,a),this.octree=b,this.cellSize=0,this.iterator=null,this.octantWrapper=new R,this.octantWrapper.id.level=c,this.result=new f,this.reset()}return i(a,[{key:"reset",value:function(){var a=this.octantWrapper.id.level,b=this.octree,c=b.getGrid(a);return void 0===c?console.error("Invalid level",a):(this.cellSize=b.getCellSize(a),this.iterator=c.entries(),this.result.reset()),this}},{key:"next",value:function(){var a=this.result,b=this.octantWrapper,c=this.iterator.next(),d=c.value;return c.done?(a.value=null,a.done=!0):(this.keyDesign.unpackKey(d[0],b.min),b.min.multiplyScalar(this.cellSize).add(this.octree.min),b.max.copy(b.min).addScalar(this.cellSize),b.id.key=d[0],b.octant=d[1],a.value=b),a}},{key:"return",value:function(a){return this.result.value=a,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),a}(),Y=new function a(){g(this,a),this.value=0},Z=new e.Vector3,$=new e.Line3,l=new e.Ray,_=function(){function a(){g(this,a)}return i(a,null,[{key:"intersectOctree",value:function(c,d){var f,g,h,i,j,k,m,o,p,r,s,u,v,w,x,A,B,C,D,F,G,e=Math.sign,H=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],I=c.getDepth(),J=c.getGrid(I),K=c.getCellSize(I),L=c.getKeyDesign(),M=new R,N=$.start,O=$.end,P=c.containsPoint(l.copy(d).origin)?l.origin:l.intersectBox(c,l.origin);if(M.id.level=I,null!==P)for(i=K<<1,j=l.at(i,Z),c.calculateKeyCoordinates(P,I,N),c.calculateKeyCoordinates(j,I,O),m=O.x-N.x,o=O.y-N.y,p=O.z-N.z,A=e(m),B=e(o),C=e(p),r=E(m),s=E(o),u=E(p),v=2*r,w=2*s,x=2*u,D=s-r,F=u-r,G=s-u,k=r+s+u;0<k;--k)g=L.packKey(N),J.has(g)&&(h=J.get(g),M.id.key=g,M.octant=h,M.min.copy(N),M.min.multiplyScalar(K),M.min.add(c.min),M.max.copy(M.min).addScalar(K),null===h.data?(f=y(M,d,Y),z.apply(void 0,[c,M.octant,N.x,N.y,N.z,c.getDepth()].concat(q(f),[H]))):H.push(M.clone())),0>D?0>F?(N.x+=A,D+=w,F+=x):(N.z+=C,F-=v,G+=w):0>G?(N.z+=C,F-=v,G+=w):(N.y+=B,D-=v,G-=x);return H}}]),a}(),aa=new e.Vector3,ba=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:20,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:8,d=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new P;for(g(this,a),c=G(F(C(c),32),1),this.cellSize=G(F(C(b),D(2,33-c)-1),1),this.keyDesign=d,this.grids=[];this.grids.length<c;)this.grids.push(new Map);this.bounds=new R,this.bounds.min.copy(this.keyDesign.halfRange).multiplyScalar(-this.cellSize),this.bounds.max.copy(this.keyDesign.halfRange).multiplyScalar(this.cellSize)}return i(a,[{key:"getKeyDesign",value:function(){return this.keyDesign}},{key:"getCellSize",value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;return this.cellSize<<a>>>0}},{key:"getCenter",value:function(a){return this.bounds.getCenter(a)}},{key:"setCenter",value:function(a){this.min.copy(this.keyDesign.halfRange).multiplyScalar(-this.cellSize).add(a),this.max.copy(this.keyDesign.halfRange).multiplyScalar(this.cellSize).add(a)}},{key:"getDimensions",value:function(a){return this.bounds.getDimensions(a)}},{key:"getGrid",value:function(a){return 0<=a&&a<this.grids.length?this.grids[a]:void 0}},{key:"clear",value:function(){var a=!0,b=!1,c=void 0;try{for(var d,e,f=this.grids[Symbol.iterator]();!(a=(d=f.next()).done);a=!0)e=d.value,e.clear()}catch(a){b=!0,c=a}finally{try{a||null==f["return"]||f["return"]()}finally{if(b)throw c}}}},{key:"containsPoint",value:function(a){return this.bounds.containsPoint(a)}},{key:"getDepth",value:function(){return this.grids.length-1}},{key:"findNodesByLevel",value:function(a){return this.octants(a)}},{key:"calculateKeyCoordinates",value:function(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new e.Vector3,d=this.cellSize<<b;return aa.subVectors(a,this.min),c.set(C(aa.x/d),C(aa.y/d),C(aa.z/d)),c}},{key:"getNodeByPoint",value:function(a){var b,c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,d=this.keyDesign,e=this.getGrid(c);return void 0===e?console.error("Invalid level",c):this.containsPoint(a)?(this.calculateKeyCoordinates(a,c,aa),b=e.get(d.packKey(aa))):console.error("Position out of range",a),b}},{key:"remove",value:function(a){var b,c,d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,f=this.keyDesign,g=this.getGrid(e);void 0===g?console.error("Invalid level",e):g.has(a)?(f.unpackKey(a,aa),b=aa.x,c=aa.y,d=aa.z,A(this,g.get(a),b,c,d,e),g["delete"](a),B(this,b,c,d,e)):console.error("No octant found",a)}},{key:"raycast",value:function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];return _.intersectOctree(this,a.ray,b)}},{key:"octants",value:function(){var a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;return new p(this,a)}},{key:"min",get:function(){return this.bounds.min}},{key:"max",get:function(){return this.bounds.max}},{key:"levels",get:function(){return this.grids.length}},{key:"levelZero",get:function(){return this.grids[0]}}],[{key:"calculateOffsetIndex",value:function(a,b,c){return((1&a)<<2)+((1&b)<<1)+(1&c)}}]),a}();a.BinaryUtils=J,a.IntermediateOctant=I,a.KeyDesign=P,a.KeyIterator=K,a.Octant=H,a.OctantId=Q,a.OctantWrapper=R,a.Octree=ba,a.OctreeIterator=p,a.OctreeRaycaster=_,Object.defineProperty(a,"__esModule",{value:!0})});
