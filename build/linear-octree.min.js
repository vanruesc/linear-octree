/**
 * linear-octree v0.0.0 build Sat Jan 18 2020
 * https://github.com/vanruesc/linear-octree
 * Copyright 2020 Raoul van RÃ¼schen
 * @license Zlib
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("math-ds"),require("iterator-result")):"function"==typeof define&&define.amd?define(["exports","math-ds","iterator-result"],t):t((e=e||self).LINEAROCTREE={},e.MATHDS,e.ITERATORRESULT)}(this,(function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function l(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}n=n&&n.hasOwnProperty("default")?n.default:n;var c=function e(){i(this,e),this.data=null},h=function(e){function t(){var e;return i(this,t),(e=u(this,s(t).call(this))).children=0,e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}(t,e),t}(c),y=function(){function e(){i(this,e)}return a(e,null,[{key:"parseBin",value:function(e){return parseInt(e,2)}},{key:"createBinaryString",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:64,n=e<0?"-":"",i=Math.abs(e).toString(2);i.length<t;)i="0"+i;return n+i}}]),e}(),g=function(){function e(r,a,s){i(this,e),this.keyDesign=r,this.min=a,this.max=s,this.keyBase=new t.Vector3,this.key=new t.Vector3,this.limit=new t.Vector3,this.result=new n,this.reset()}return a(e,[{key:"reset",value:function(){var e=this.keyDesign,t=this.min,n=this.max;return t.x<=n.x&&t.y<=n.y&&t.z<=n.z?(this.keyBase.set(t.x,t.y*e.rangeX,t.z*e.rangeXY),this.limit.set(n.x,n.y*e.rangeX,n.z*e.rangeXY),this.key.copy(this.keyBase)):(this.keyBase.set(1,1,1),this.limit.set(0,0,0),this.key.copy(this.keyBase),console.error("Invalid key range",t,n)),this.result.reset(),this}},{key:"next",value:function(){var e=this.result,t=this.keyDesign,n=this.keyBase,i=this.limit,r=this.key;return r.z<=i.z?(e.value=r.z+r.y+r.x,++r.x,r.x>i.x&&(r.x=n.x,r.y+=t.rangeX,r.y>i.y&&(r.y=n.y,r.z+=t.rangeXY))):(e.value=null,e.done=!0),e}},{key:"return",value:function(e){return this.result.value=e,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),e}(),f=Math.pow(2,32),v=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.round(53*.4),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Math.round(53*.2),r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t;i(this,e),this.x=0,this.y=0,this.z=0,this.rangeX=0,this.rangeY=0,this.rangeZ=0,this.rangeXY=0,this.halfRange=null,this.maskX=[0,0],this.maskY=[0,0],this.maskZ=[0,0],this.set(t,n,r)}return a(e,[{key:"set",value:function(e,n,i){(e+n+i>53||e>32||n>32||i>32)&&(console.warn("Invalid bit allotment"),e=Math.round(53*.4),n=Math.round(53*.2),i=e),this.x=e,this.y=n,this.z=i,this.rangeX=Math.pow(2,e),this.rangeY=Math.pow(2,n),this.rangeZ=Math.pow(2,i),this.rangeXY=Math.pow(2,e+n),this.halfRange=new t.Vector3(this.rangeX/2,this.rangeY/2,this.rangeZ/2),this.updateBitMasks()}},{key:"updateBitMasks",value:function(){var e=this.x,t=this.y,n=this.z,i=this.maskX,r=this.maskY,a=this.maskZ,s=32-Math.max(0,e-32),o=32-Math.max(0,t+e-32),u=32-Math.max(0,n+t+e-32);i[1]=s<32?-1>>>s:0,i[0]=-1>>>Math.max(0,32-e),r[1]=((o<32?-1>>>o:0)&~i[1])>>>0,r[0]=(-1>>>Math.max(0,32-(e+t))&~i[0])>>>0,a[1]=((u<32?-1>>>u:0)&~r[1]&~i[1])>>>0,a[0]=(-1>>>Math.max(0,32-(e+t+n))&~r[0]&~i[0])>>>0}},{key:"unpackKey",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t.Vector3,i=this.maskX,r=this.maskY,a=this.maskZ,s=Math.trunc(e/f),o=e%f;return n.set((s&i[1])*f+((o&i[0])>>>0),((s&r[1])*f+((o&r[0])>>>0))/this.rangeX,((s&a[1])*f+((o&a[0])>>>0))/this.rangeXY)}},{key:"packKey",value:function(e){return e.z*this.rangeXY+e.y*this.rangeX+e.x}},{key:"keyRange",value:function(e,t){return new g(this,e,t)}},{key:"toString",value:function(){var e=this.maskX,t=this.maskY,n=this.maskZ;return"Key Design\n\nX-Bits: "+this.x+"\nY-Bits: "+this.y+"\nZ-Bits: "+this.z+"\n\n"+y.createBinaryString(e[1],32)+" "+e[1]+" (HI-Mask X)\n"+y.createBinaryString(e[0],32)+" "+e[0]+" (LO-Mask X)\n\n"+y.createBinaryString(t[1],32)+" "+t[1]+" (HI-Mask Y)\n"+y.createBinaryString(t[0],32)+" "+t[0]+" (LO-Mask Y)\n\n"+y.createBinaryString(n[1],32)+" "+n[1]+" (HI-Mask Z)\n"+y.createBinaryString(n[0],32)+" "+n[0]+" (LO-Mask Z)\n"}}],[{key:"BITS",get:function(){return 53}},{key:"HI_BITS",get:function(){return 21}},{key:"LO_BITS",get:function(){return 32}}]),e}(),d=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,e),this.level=t,this.key=n}return a(e,[{key:"set",value:function(e,t){this.level=e,this.key=t}},{key:"copy",value:function(e){return this.level=e.level,this.key=e.key,this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),e}(),k=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new d;i(this,e),this.octant=n,this.id=r,this.min=new t.Vector3,this.max=new t.Vector3}return a(e,[{key:"copy",value:function(e){return this.octant=e.octant,this.id.copy(e.id),this.min.copy(e.min),this.max.copy(e.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"getCenter",value:function(e){return e.addVectors(this.min,this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(e){return e.subVectors(this.max,this.min)}},{key:"containsPoint",value:function(e){var t=this.min,n=this.max;return e.x>=t.x&&e.y>=t.y&&e.z>=t.z&&e.x<=n.x&&e.y<=n.y&&e.z<=n.z}}]),e}(),p=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])];new t.Vector3,new t.Vector3;var m=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])];function x(e,t,n,i){var r,a=0;return t<n?(r=t,a=0):(r=n,a=1),i<r&&(a=2),m[e][a]}var w=new t.Vector3,z=new t.Box3,b=new t.Box3,M=new t.Ray;function S(e,t,n){var i,r,a,s,o,u,l,c,h,y=z.min.set(0,0,0),g=z.max.subVectors(e.max,e.min),f=e.getDimensions(b.min),v=b.max.copy(f).multiplyScalar(.5),d=M.origin.copy(t.origin),k=M.direction.copy(t.direction);return d.sub(e.getCenter(w)).add(v),n.value=0,k.x<0&&(d.x=f.x-d.x,k.x=-k.x,n.value|=4),k.y<0&&(d.y=f.y-d.y,k.y=-k.y,n.value|=2),k.z<0&&(d.z=f.z-d.z,k.z=-k.z,n.value|=1),i=1/k.x,r=1/k.y,a=1/k.z,s=(y.x-d.x)*i,o=(g.x-d.x)*i,u=(y.y-d.y)*r,l=(g.y-d.y)*r,c=(y.z-d.z)*a,h=(g.z-d.z)*a,Math.max(Math.max(s,u),c)<Math.min(Math.min(o,l),h)?[s,u,c,o,l,h]:null}new t.Box3,new t.Box3,new t.Vector3;var O=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,e),this.octree=t,this.cellSize=0,this.iterator=null,this.octantWrapper=new k,this.octantWrapper.id.level=r,this.result=new n,this.reset()}return a(e,[{key:"reset",value:function(){var e=this.octantWrapper.id.level,t=this.octree,n=t.getGrid(e);return void 0!==n?(this.cellSize=t.getCellSize(e),this.iterator=n.entries(),this.result.reset()):console.error("Invalid level",e),this}},{key:"next",value:function(){var e=this.result,t=this.octantWrapper,n=this.iterator.next(),i=n.value;return n.done?(e.value=null,e.done=!0):(this.keyDesign.unpackKey(i[0],t.min),t.min.multiplyScalar(this.cellSize).add(this.octree.min),t.max.copy(t.min).addScalar(this.cellSize),t.id.key=i[0],t.octant=i[1],e.value=t),e}},{key:"return",value:function(e){return this.result.value=e,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),e}(),B=new function e(){i(this,e),this.value=0},K=new t.Vector3,D=new t.Line3,A=new t.Ray;function I(e,t,n,i,r,a,s,o,u,l,c,h,y){if(l>=0&&c>=0&&h>=0){var g=e.getKeyDesign();if(0===a||null!==t.data){var f=e.getCellSize(a),v=new k(t);v.id.set(a,g.packKey(K.set(n,i,r))),v.min.copy(K).multiplyScalar(f).add(e.min),v.max.copy(v.min).addScalar(f),y.push(v)}else if(t.children>0){var d,m,w,z=e.getGrid(--a),b=t.children,M=.5*(s+l),S=.5*(o+c),O=.5*(u+h),D=function(e,t,n,i,r,a){var s=0;return e>t&&e>n?(r<e&&(s|=2),a<e&&(s|=1)):t>n?(i<t&&(s|=4),a<t&&(s|=1)):(i<n&&(s|=4),r<n&&(s|=2)),s}(s,o,u,M,S,O);n<<=1,i<<=1,r<<=1;do{switch(m=0!=(b&1<<(w=B.value^D)),d=p[w],D){case 0:m&&(K.set(n+d[0],i+d[1],r+d[2]),I(e,z.get(g.packKey(K)),K.x,K.y,K.z,a,s,o,u,M,S,O,y)),D=x(D,M,S,O);break;case 1:m&&(K.set(n+d[0],i+d[1],r+d[2]),I(e,z.get(g.packKey(K)),K.x,K.y,K.z,a,s,o,O,M,S,h,y)),D=x(D,M,S,h);break;case 2:m&&(K.set(n+d[0],i+d[1],r+d[2]),I(e,z.get(g.packKey(K)),K.x,K.y,K.z,a,s,S,u,M,c,O,y)),D=x(D,M,c,O);break;case 3:m&&(K.set(n+d[0],i+d[1],r+d[2]),I(e,z.get(g.packKey(K)),K.x,K.y,K.z,a,s,S,O,M,c,h,y)),D=x(D,M,c,h);break;case 4:m&&(K.set(n+d[0],i+d[1],r+d[2]),I(e,z.get(g.packKey(K)),K.x,K.y,K.z,a,M,o,u,l,S,O,y)),D=x(D,l,S,O);break;case 5:m&&(K.set(n+d[0],i+d[1],r+d[2]),I(e,z.get(g.packKey(K)),K.x,K.y,K.z,a,M,o,O,l,S,h,y)),D=x(D,l,S,h);break;case 6:m&&(K.set(n+d[0],i+d[1],r+d[2]),I(e,z.get(g.packKey(K)),K.x,K.y,K.z,a,M,S,u,l,c,O,y)),D=x(D,l,c,O);break;case 7:m&&(K.set(n+d[0],i+d[1],r+d[2]),I(e,z.get(g.packKey(K)),K.x,K.y,K.z,a,M,S,O,l,c,h,y)),D=8}}while(D<8)}}}var X=function(){function e(){i(this,e)}return a(e,null,[{key:"intersectOctree",value:function(e,t){var n,i,r,a,s,o,u,c,h,y,g,f,v,d,p,m,x,w,z,b,M,O=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],X=e.getDepth(),U=e.getGrid(X),V=e.getCellSize(X),Y=e.getKeyDesign(),R=new k,C=D.start,P=D.end,j=e.containsPoint(A.copy(t).origin)?A.origin:A.intersectBox(e,A.origin);if(R.id.level=X,null!==j)for(a=V<<1,s=A.at(a,K),e.calculateKeyCoordinates(j,X,C),e.calculateKeyCoordinates(s,X,P),u=P.x-C.x,c=P.y-C.y,h=P.z-C.z,m=Math.sign(u),x=Math.sign(c),w=Math.sign(h),v=2*(y=Math.abs(u)),d=2*(g=Math.abs(c)),p=2*(f=Math.abs(h)),z=g-y,b=f-y,M=g-f,o=y+g+f;o>0;--o)i=Y.packKey(C),U.has(i)&&(r=U.get(i),R.id.key=i,R.octant=r,R.min.copy(C),R.min.multiplyScalar(V),R.min.add(e.min),R.max.copy(R.min).addScalar(V),null===r.data?(n=S(R,t,B),I.apply(void 0,[e,R.octant,C.x,C.y,C.z,e.getDepth()].concat(l(n),[O]))):O.push(R.clone())),z<0?b<0?(C.x+=m,z+=d,b+=p):(C.z+=w,b-=v,M+=d):M<0?(C.z+=w,b-=v,M+=d):(C.y+=x,z-=v,M-=p);return O}}]),e}(),U=new t.Vector3;function V(e,t,n,i,r,a){var s,o,u,l,c,h,y;if(a>0){for(--a,s=e.getGrid(a),o=e.getKeyDesign(),u=t.children,n<<=1,i<<=1,r<<=1,y=0;y<8;++y)0!=(u&1<<y)&&(c=p[y],U.set(n+c[0],i+c[1],r+c[2]),h=o.packKey(U),l=s.get(h),s.delete(h),V(e,l,U.x,U.y,U.z,a));t.children=0}}function Y(e,t,n,i,r){var a,s,o,u;++r<e.levels&&(a=e.getGrid(r),s=R.calculateOffsetIndex(t,n,i),U.set(t>>>1,n>>>1,i>>>1),o=e.getKeyDesign().packKey(U),(u=a.get(o)).children&=~(1<<s),0===u.children&&(a.delete(o),Y(e,U.x,U.y,U.z,r)))}var R=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new v;for(i(this,e),n=Math.max(Math.min(Math.trunc(n),32),1),this.cellSize=Math.max(Math.min(Math.trunc(t),Math.pow(2,33-n)-1),1),this.keyDesign=r,this.grids=[];this.grids.length<n;)this.grids.push(new Map);this.bounds=new k,this.bounds.min.copy(this.keyDesign.halfRange).multiplyScalar(-this.cellSize),this.bounds.max.copy(this.keyDesign.halfRange).multiplyScalar(this.cellSize)}return a(e,[{key:"getKeyDesign",value:function(){return this.keyDesign}},{key:"getCellSize",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.cellSize<<e>>>0}},{key:"getCenter",value:function(e){return this.bounds.getCenter(e)}},{key:"setCenter",value:function(e){this.min.copy(this.keyDesign.halfRange).multiplyScalar(-this.cellSize).add(e),this.max.copy(this.keyDesign.halfRange).multiplyScalar(this.cellSize).add(e)}},{key:"getDimensions",value:function(e){return this.bounds.getDimensions(e)}},{key:"getGrid",value:function(e){return e>=0&&e<this.grids.length?this.grids[e]:void 0}},{key:"clear",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,r=this.grids[Symbol.iterator]();!(e=(i=r.next()).done);e=!0){i.value.clear()}}catch(e){t=!0,n=e}finally{try{e||null==r.return||r.return()}finally{if(t)throw n}}}},{key:"containsPoint",value:function(e){return this.bounds.containsPoint(e)}},{key:"getDepth",value:function(){return this.grids.length-1}},{key:"findNodesByLevel",value:function(e){return this.octants(e)}},{key:"calculateKeyCoordinates",value:function(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new t.Vector3,r=this.cellSize<<n;return U.subVectors(e,this.min),i.set(Math.trunc(U.x/r),Math.trunc(U.y/r),Math.trunc(U.z/r)),i}},{key:"getNodeByPoint",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=this.keyDesign,r=this.getGrid(n);return void 0!==r?this.containsPoint(e)?(this.calculateKeyCoordinates(e,n,U),t=r.get(i.packKey(U))):console.error("Position out of range",e):console.error("Invalid level",n),t}},{key:"remove",value:function(e){var t,n,i,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=this.keyDesign,s=this.getGrid(r);void 0!==s?s.has(e)?(a.unpackKey(e,U),t=U.x,n=U.y,i=U.z,V(this,s.get(e),t,n,i,r),s.delete(e),Y(this,t,n,i,r)):console.error("No octant found",e):console.error("Invalid level",r)}},{key:"raycast",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return X.intersectOctree(this,e.ray,t)}},{key:"octants",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new O(this,e)}},{key:"min",get:function(){return this.bounds.min}},{key:"max",get:function(){return this.bounds.max}},{key:"levels",get:function(){return this.grids.length}},{key:"levelZero",get:function(){return this.grids[0]}}],[{key:"calculateOffsetIndex",value:function(e,t,n){return((1&e)<<2)+((1&t)<<1)+(1&n)}}]),e}();e.BinaryUtils=y,e.IntermediateOctant=h,e.KeyDesign=v,e.KeyIterator=g,e.Octant=c,e.OctantId=d,e.OctantWrapper=k,e.Octree=R,e.OctreeIterator=O,e.OctreeRaycaster=X,Object.defineProperty(e,"__esModule",{value:!0})}));
